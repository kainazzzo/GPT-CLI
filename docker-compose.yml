services:
  discord:
    build:
        context: .
        dockerfile: Dockerfile.discord
    restart: unless-stopped
    volumes:
      - ./deploy/appsettings.json:/app/appsettings.json:ro
      - /usr/local/discord/channels:/app/channels
      - /usr/local/discord/modules:/app/modules
  builder:
    image: mcr.microsoft.com/dotnet/sdk:10.0
    working_dir: /src
    volumes:
      - ./:/src
      - /usr/local/discord/modules:/usr/local/discord/modules
      # Persist NuGet caches across builder runs so module builds/publish don't re-download packages.
      - nuget_packages:/root/.nuget/packages
      - nuget_v3_cache:/root/.local/share/NuGet/v3-cache
    command: >-
      bash -lc "dotnet restore gpt.csproj -r linux-x64 &&
      dotnet publish gpt.csproj -c Release -r linux-x64
      --self-contained true -p:PublishSingleFile=true
      --no-restore -o /tmp/gpt-publish"
    profiles:
      - manual

volumes:
  nuget_packages:
  nuget_v3_cache:
